<!DOCTYPE html>
<html>
<head>
    <title>MEAN Stack Application</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #f0f2f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; }
        .btn { background: #007bff; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; margin: 5px; }
        .btn:hover { background: #0056b3; }
        .btn-refresh { background: #28a745; }
        .btn-test { background: #6c757d; }
        .tutorial { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 6px; }
        .status { padding: 15px; margin: 15px 0; border-radius: 6px; display: none; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        input, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; }
        textarea { height: 100px; resize: vertical; }
        .api-info { background: #f8f9fa; padding: 15px; border-radius: 6px; margin: 15px 0; }
        .debug-panel { background: #343a40; color: white; padding: 15px; border-radius: 6px; margin: 15px 0; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; }
        .debug-title { color: #17a2b8; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <h1>MEAN Stack CRUD Application</h1>
        
        <div class="api-info">
            <strong>Backend API:</strong> <span id="api-url">http://localhost:5000</span><br>
            <button class="btn btn-test" onclick="testConnection()">Test Connection</button>
            <button class="btn btn-test" onclick="testEndpoints()">Test All Endpoints</button>
        </div>
        
        <div id="status" class="status"></div>
        
        <div class="debug-panel">
            <div class="debug-title" onclick="toggleDebug()">▼ Debug Console</div>
            <div id="debug-output"></div>
        </div>
        
        <h3>Add New Tutorial</h3>
        <input id="title" placeholder="Title">
        <textarea id="description" placeholder="Description"></textarea>
        <button class="btn" onclick="addTutorial()">Add Tutorial</button>
        
        <h3>Tutorials in Database</h3>
        <button class="btn btn-refresh" onclick="loadTutorials()">Refresh List</button>
        <div id="tutorials"></div>
    </div>
    
    <script>
        // API URL
        const API_BASE = 'http://' + window.location.hostname + ':5000';
        const API_URL = API_BASE + '/api/tutorials';
        const TEST_URL = API_BASE + '/api/test';
        
        // Display API URL
        document.getElementById('api-url').textContent = API_BASE;
        
        // Debug logging
        let debugOpen = true;
        function logDebug(message) {
            const debugEl = document.getElementById('debug-output');
            const timestamp = new Date().toLocaleTimeString();
            debugEl.innerHTML += `[${timestamp}] ${message}<br>`;
            debugEl.scrollTop = debugEl.scrollHeight;
        }
        
        function toggleDebug() {
            const debugEl = document.getElementById('debug-output');
            const title = document.querySelector('.debug-title');
            debugOpen = !debugOpen;
            debugEl.style.display = debugOpen ? 'block' : 'none';
            title.textContent = (debugOpen ? '▼' : '▶') + ' Debug Console';
        }
        
        function showMessage(text, type = 'success') {
            const status = document.getElementById('status');
            status.textContent = text;
            status.className = `status ${type}`;
            status.style.display = 'block';
            setTimeout(() => status.style.display = 'none', 5000);
            logDebug(`${type.toUpperCase()}: ${text}`);
        }
        
        // Test connection to backend
        async function testConnection() {
            try {
                logDebug(`Testing connection to: ${API_BASE}/`);
                const response = await fetch(API_BASE + '/');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                showMessage(`✅ Connected! ${data.message}`, 'success');
                logDebug(`Response: ${JSON.stringify(data)}`);
                
            } catch (error) {
                showMessage(`❌ Connection failed: ${error.message}`, 'error');
                logDebug(`Error: ${error.message}`);
            }
        }
        
        // Test all endpoints
        async function testEndpoints() {
            const endpoints = [
                { path: '/', method: 'GET' },
                { path: '/api/test', method: 'GET' },
                { path: '/api/tutorials', method: 'GET' }
            ];
            
            for (const endpoint of endpoints) {
                try {
                    logDebug(`Testing ${endpoint.method} ${endpoint.path}`);
                    const response = await fetch(API_BASE + endpoint.path, {
                        method: endpoint.method
                    });
                    
                    logDebug(`Response: HTTP ${response.status} ${response.statusText}`);
                    
                    if (response.ok) {
                        const data = await response.json();
                        logDebug(`Data: ${JSON.stringify(data).substring(0, 100)}...`);
                    }
                } catch (error) {
                    logDebug(`Error: ${error.message}`);
                }
            }
        }
        
        async function addTutorial() {
            const title = document.getElementById('title').value.trim();
            const description = document.getElementById('description').value.trim();
            
            if (!title || !description) {
                showMessage('Please fill in both fields', 'error');
                return;
            }
            
            try {
                showMessage('Saving to database...', 'info');
                logDebug(`POST ${API_URL} with: ${JSON.stringify({title, description})}`);
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ title, description })
                });
                
                logDebug(`Response: HTTP ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const result = await response.json();
                    showMessage('✅ Tutorial saved successfully!', 'success');
                    logDebug(`Saved: ${JSON.stringify(result)}`);
                    document.getElementById('title').value = '';
                    document.getElementById('description').value = '';
                    loadTutorials();
                } else {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage(`❌ Error: ${error.message}`, 'error');
                logDebug(`Error details: ${error.message}`);
            }
        }
        
        async function loadTutorials() {
            try {
                showMessage('Loading tutorials...', 'info');
                logDebug(`GET ${API_URL}`);
                
                const response = await fetch(API_URL, {
                    headers: { 'Accept': 'application/json' }
                });
                
                logDebug(`Response: HTTP ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const tutorials = await response.json();
                const container = document.getElementById('tutorials');
                
                logDebug(`Received ${tutorials.length} tutorials`);
                
                if (!tutorials || tutorials.length === 0) {
                    container.innerHTML = '<div class="tutorial"><p>No tutorials found. Add one above!</p></div>';
                    showMessage('No tutorials in database', 'info');
                    return;
                }
                
                container.innerHTML = tutorials.map(tutorial => `
                    <div class="tutorial">
                        <h4>${escapeHtml(tutorial.title)}</h4>
                        <p>${escapeHtml(tutorial.description)}</p>
                        <small>ID: ${tutorial._id}</small>
                    </div>
                `).join('');
                
                showMessage(`✅ Loaded ${tutorials.length} tutorial(s)`, 'success');
            } catch (error) {
                console.error('Error:', error);
                showMessage(`❌ Error loading: ${error.message}`, 'error');
                logDebug(`Load error: ${error.message}`);
                document.getElementById('tutorials').innerHTML = 
                    '<div class="tutorial"><p>Cannot connect to backend. Click "Test Connection" to debug.</p></div>';
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            logDebug('Page loaded');
            logDebug(`API Base URL: ${API_BASE}`);
            logDebug(`Tutorials URL: ${API_URL}`);
            
            // Test connection on load
            setTimeout(testConnection, 1000);
            setTimeout(loadTutorials, 1500);
        });
    </script>
</body>
</html>
